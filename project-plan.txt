nest new cirql-backend
cd cirql-backend
# MongoDB
pnpm add @nestjs/mongoose mongoose

# Configuration
pnpm add @nestjs/config

# JWT
pnpm add @nestjs/jwt passport-jwt
pnpm add -D @types/passport-jwt # -D for dev dependency

# Google OAuth
pnpm add @nestjs/passport passport passport-google-oauth20
pnpm add -D @types/passport-google-oauth20

# Swagger
pnpm add @nestjs/swagger swagger-ui-express

# Validation
pnpm add class-validator class-transformer

# Security
pnpm add helmet


PORT=3001
MONGODB_URI=your_mongodb_connection_string
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=http://localhost:3001/auth/google/callback
JWT_SECRET=your_super_secret_jwt_key
JWT_EXPIRATION_TIME=3600s
FRONTEND_URL=http://localhost:3000 # Or your frontend's port

nest g module users
nest g service users
nest g controller users --no-spec

nest g module auth
nest g service auth
nest g controller auth --no-spec

pnpm add bcrypt
pnpm add -D @types/bcrypt

pnpm add joi

Okay, here's a concise note summarizing the key configurations and purposes of the 4 different environment setups (2 for backend, 2 for frontend) to help you recall and explain it later:
Core Concept: The goal is flexible authentication across different environments (local/production frontend talking to local/production backend). This is achieved by:
Backend's Passport strategy always using its own environment-specific callback URL (GOOGLE_CALLBACK_TO_BACKEND_URL).
Frontend dynamically sending its own desired callback URL (where it wants to receive the token) to the backend via the state parameter (finalRedirectUri).
Backend validating this finalRedirectUri against a whitelist (ALLOWED_FRONTEND_ORIGINS) before redirecting the user with the JWT.
I. Backend Environment Configurations
(A) Backend - LOCAL DEVELOPMENT (cirql-backend/.env)
NODE_ENV: development
BACKEND_URL: http://localhost:3001
GOOGLE_CALLBACK_TO_BACKEND_URL: http://localhost:3001/auth/google/callback
Purpose: Tells Google where to send the auth code back to this local backend. Must be in Google Console's "Authorized redirect URIs".
FRONTEND_URL: http://localhost:3000
Purpose: Default/fallback URL for the frontend if state is invalid/missing.
ALLOWED_FRONTEND_ORIGINS: http://localhost:3000,https://cirql.vercel.app
Purpose: Whitelist of frontend origins this local backend will trust to redirect to with a token (allows testing local BE with prod FE, or local BE with local FE).
Secrets (MONGODB_URI, JWT_SECRET, GOOGLE_CLIENT_ID/SECRET): Development-specific values.
(B) Backend - PRODUCTION (Platform Env Vars, e.g., on Vercel for cirql-backend)
NODE_ENV: production
BACKEND_URL: https://cirql-backend.vercel.app (your actual deployed backend URL)
GOOGLE_CALLBACK_TO_BACKEND_URL: https://cirql-backend.vercel.app/auth/google/callback
Purpose: Tells Google where to send the auth code back to this production backend. Must be in Google Console's "Authorized redirect URIs".
FRONTEND_URL: https://cirql.vercel.app
Purpose: Default/fallback URL for the production frontend.
ALLOWED_FRONTEND_ORIGINS: https://cirql.vercel.app,http://localhost:3000
Purpose: Whitelist of frontend origins this production backend will trust (allows prod BE with prod FE, or prod BE with local FE for testing).
Secrets (MONGODB_URI, JWT_SECRET, GOOGLE_CLIENT_ID/SECRET): Production-grade, secure values.
II. Frontend Environment Configurations
(C) Frontend - LOCAL DEVELOPMENT (No .env.local; using next.config.js defaults or shell vars)
NEXT_PUBLIC_BACKEND_URL: Typically defaults to http://localhost:3001 (local backend). Can be overridden (e.g., via shell command NEXT_PUBLIC_BACKEND_URL=https://cirql-backend.vercel.app pnpm dev) to point local frontend to production backend for testing.
NEXT_PUBLIC_FRONTEND_URL: http://localhost:3000 (default for local).
finalRedirectUri in state parameter (Dynamically Generated): http://localhost:3000/auth/google/callback
Purpose: Tells the backend (local or prod) where this local frontend expects to receive the token.
(D) Frontend - PRODUCTION (Platform Env Vars, e.g., on Vercel for cirql-frontend)
NEXT_PUBLIC_BACKEND_URL: https://cirql-backend.vercel.app (points to production backend).
NEXT_PUBLIC_FRONTEND_URL: https://cirql.vercel.app.
finalRedirectUri in state parameter (Dynamically Generated): https://cirql.vercel.app/auth/google/callback
Purpose: Tells the production backend where this production frontend expects to receive the token.
Key Takeaway for Explaining Later:
Backend's GOOGLE_CALLBACK_TO_BACKEND_URL is static for its environment (local or prod) and tells Google where to send the initial code.
Frontend's finalRedirectUri (in state) is dynamic and tells the backend where the frontend client wants the final JWT redirect.
Backend's ALLOWED_FRONTEND_ORIGINS acts as a security whitelist for that final JWT redirect, ensuring the backend only sends tokens to trusted frontend origins, regardless of what the state parameter claims. This list should contain both your production frontend origin and http://localhost:3000 in both backend environments to allow flexible testing.
This setup achieves your goal: authentication can work "no matter what the environment is" (local FE to local BE, local FE to prod BE, prod FE to prod BE) because the system is designed to handle these different origin combinations through configuration and the dynamic state parameter.
cirql-backend/
â”œâ”€â”€ .env                    # (Not provided, assumed)
â”œâ”€â”€ .eslintrc.mjs           # Updated config file you provided
â”œâ”€â”€ .gitignore              # (Not provided, assumed)
â”œâ”€â”€ .prettierrc             # (Not provided, assumed)
â”œâ”€â”€ nest-cli.json           # (Not provided, assumed)
â”œâ”€â”€ package.json            # (Not provided, assumed)
â”œâ”€â”€ tsconfig.build.json     # (Not provided, assumed)
â”œâ”€â”€ tsconfig.json           # Your tsconfig file
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts
â”‚   â”œâ”€â”€ app.controller.ts
â”‚   â”œâ”€â”€ app.module.ts
â”‚   â”œâ”€â”€ app.service.ts
â”‚   â”œâ”€â”€ announcement/
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-announcement.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ update-announcement.dto.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â””â”€â”€ announcement.entity.ts
â”‚   â”‚   â”œâ”€â”€ announcement.controller.ts
â”‚   â”‚   â”œâ”€â”€ announcement.module.ts
â”‚   â”‚   â””â”€â”€ announcement.service.ts
â”‚   â”œâ”€â”€ audit/
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â””â”€â”€ audit-log.schema.ts
â”‚   â”‚   â”œâ”€â”€ audit.controller.ts
â”‚   â”‚   â”œâ”€â”€ audit.module.ts
â”‚   â”‚   â””â”€â”€ audit.service.ts
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”‚   â””â”€â”€ current-user.decorator.ts
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ disable-2fa.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ forgot-password.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ login-2fa.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ login.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ reset-password.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ two-factor-code.dto.ts
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ password-reset-token.schema.ts
â”‚   â”‚   â”‚   â””â”€â”€ two-factor-token.schema.ts
â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â”‚   â”œâ”€â”€ google.strategy.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt-2fa.strategy.ts
â”‚   â”‚   â”‚   â””â”€â”€ jwt.strategy.ts
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â””â”€â”€ encryption.service.ts
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”‚   â””â”€â”€ roles.decorator.ts
â”‚   â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â”‚   â””â”€â”€ role.enum.ts
â”‚   â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”‚   â”œâ”€â”€ banned-user.guard.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ optional-auth.guard.ts
â”‚   â”‚   â”‚   â””â”€â”€ roles.guard.ts
â”‚   â”‚   â””â”€â”€ pipes/
â”‚   â”‚       â””â”€â”€ parse-object-id.pipe.ts
â”‚   â”œâ”€â”€ email/
â”‚   â”‚   â”œâ”€â”€ email.module.ts
â”‚   â”‚   â””â”€â”€ email.service.ts
â”‚   â”œâ”€â”€ notifications/
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-notification.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ mark-read.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ update-notification.dto.ts
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â””â”€â”€ notification.schema.ts
â”‚   â”‚   â”œâ”€â”€ notifications.controller.ts
â”‚   â”‚   â”œâ”€â”€ notifications.module.ts
â”‚   â”‚   â””â”€â”€ notifications.service.ts
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-setting.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ update-setting.dto.ts
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â””â”€â”€ setting.schema.ts
â”‚   â”‚   â”œâ”€â”€ settings.controller.ts
â”‚   â”‚   â”œâ”€â”€ settings.module.ts
â”‚   â”‚   â””â”€â”€ settings.service.ts
â”‚   â”œâ”€â”€ social/
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-group.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ manage-group-member.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ send-friend-request.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ update-group.dto.ts
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ friend-request.schema.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ group.schema.ts
â”‚   â”‚   â”‚   â””â”€â”€ social-profile.schema.ts
â”‚   â”‚   â”œâ”€â”€ followers.controller.ts
â”‚   â”‚   â”œâ”€â”€ followers.service.ts
â”‚   â”‚   â”œâ”€â”€ friends.controller.ts
â”‚   â”‚   â”œâ”€â”€ friends.service.ts
â”‚   â”‚   â”œâ”€â”€ groups.controller.ts
â”‚   â”‚   â”œâ”€â”€ groups.service.ts
â”‚   â”‚   â”œâ”€â”€ recommendations.controller.ts
â”‚   â”‚   â”œâ”€â”€ recommendations.service.ts
â”‚   â”‚   â”œâ”€â”€ social.controller.ts
â”‚   â”‚   â”œâ”€â”€ social.module.ts
â”‚   â”‚   â””â”€â”€ social.service.ts
â”‚   â”œâ”€â”€ support/
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-appeal.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ create-public-ticket.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ create-support.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ update-support.dto.ts
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ message.schema.ts
â”‚   â”‚   â”‚   â””â”€â”€ ticket.schema.ts
â”‚   â”‚   â”œâ”€â”€ support.controller.ts
â”‚   â”‚   â”œâ”€â”€ support.module.ts
â”‚   â”‚   â””â”€â”€ support.service.ts
â”‚   â””â”€â”€ users/
â”‚       â”œâ”€â”€ dto/
â”‚       â”‚   â”œâ”€â”€ ban-user.dto.ts
â”‚       â”‚   â”œâ”€â”€ public-profile.dto.ts
â”‚       â”‚   â”œâ”€â”€ update-user-roles.dto.ts
â”‚       â”‚   â””â”€â”€ update-user.dto.ts
â”‚       â”œâ”€â”€ schemas/
â”‚       â”‚   â””â”€â”€ user.schema.ts
â”‚       â”œâ”€â”€ users.controller.ts
â”‚       â”œâ”€â”€ users.module.ts
â”‚       â””â”€â”€ users.service.ts
â”œâ”€â”€ dist/                   # (Output directory, assumed)
â”œâ”€â”€ node_modules/           # (Dependencies, assumed)
â”œâ”€â”€ public/                 # (Static assets, assumed)
â””â”€â”€ test/                   # (Tests, assumed)

        {
  "title": "CiRQL is Born! ðŸŽ‰",
  "content": "On May 15, 2025, CiRQL was created to help people connect meaningfully in private spaces. We're building a better way to stay connected with the people and topics that matter to you. Join us!",
  "type": "Company News",  "visible": true,
  "expirationDate": null,
  "imageUrl": "https://raw.githubusercontent.com/sheikhmahmudulhasanshium/cirql-frontend/refs/heads/main/public/logo.png",
  "linkUrl": "https://cirql.vercel.app/"
}
{
  "title": "Backend is LIVE! ðŸš€",
  "content": "Great news! The backend is now up and running and connected with the frontend. ðŸŽ‰ Launched on May 28th, 2025! Check out the API at https://cirql-backend.vercel.app/api/. Exciting times ahead! ðŸ¥³",
  "type": "Company News",
  "visible": true,
  "expirationDate": null,
  "imageUrl": "https://raw.githubusercontent.com/sheikhmahmudulhasanshium/cirql-backend/refs/heads/main/public/logo.png",
  "linkUrl": "https://cirql-backend.vercel.app/api/"
}

//prompt
Let's continue our discussion about the ideal user management system we were designing. To recap, we discussed implementing a granular RBAC system (user, admin, owner, etc.) with specific permissions, enforcing unique user identification (internal ID, email), adding MFA, and improving security measures (rate limiting, audit logs, etc.). We also defined the data structure and an example API response for a `getAll` users endpoint with filtering, pagination, and error handling.

My specific question/topic for today is: [Insert your specific question or topic here]. For example: "How should we handle password resets?" or "Can we discuss the best approach for implementing audit logging?" or "What are some options for the frontend to handle the paginated `getAll` API response?"

//current data getAll
[
  {
    "_id": "68373bb20386e48d16144d6d",
    "email": "officials.shium@gmail.com",
    "firstName": "Sheikh Mahmudul Hasan",
    "lastName": "Shium",
    "googleId": "104840201035956112465",
    "picture": "https://lh3.googleusercontent.com/a/ACg8ocJRqt6KW8uwv_1QeBDBSLkDMBZNAl_-7EEtP3i_L65VIeetaq8=s96-c",
    "createdAt": "2025-05-28T16:37:06.828Z",
    "updatedAt": "2025-06-15T06:02:55.971Z",
    "__v": 0,
    "accountStatus": "active",
    "role": "admin",
    "id": "68373bb20386e48d16144d6d"
  },
  {
    "_id": "68377756edbb4d47472fa4a1",
    "email": "sheikh.mahmudul.hasan.shium.aiub@gmail.com",
    "firstName": "Sheikh Mahmudul Hasan",
    "lastName": "Shium",
    "googleId": "104804616637310003292",
    "picture": "https://lh3.googleusercontent.com/a/ACg8ocLImafbhVF7QnTNyr4bSE4BZArg8t7Fg-_tHcMViV1fffINAMg=s96-c",
    "createdAt": "2025-05-28T20:51:34.556Z",
    "updatedAt": "2025-06-15T06:02:58.013Z",
    "__v": 0,
    "accountStatus": "active",
    "role": "admin",
    "id": "68377756edbb4d47472fa4a1"
  },
  {
    "_id": "68470e79a5ec9905a77ebb09",
    "email": "shanjidasaima2020@gmail.com",
    "firstName": "Shanjida",
    "lastName": "Saima",
    "googleId": "109065821932479661428",
    "picture": "https://lh3.googleusercontent.com/a/ACg8ocJEIQ6gi3zz8jTdcp_DUi9A1tuRZ2m_xcRvYyHNdWl7G_73mQ=s96-c",
    "createdAt": "2025-06-09T16:40:25.053Z",
    "updatedAt": "2025-06-09T16:40:25.053Z",
    "__v": 0,
    "accountStatus": "active",
    "role": "user",
    "id": "68470e79a5ec9905a77ebb09"
  },
  {
    "_id": "684d765e12e2d6b55490dd63",
    "email": "sheikhmahmudulhasanshium2000@gmail.com",
    "firstName": "Sheikh Mahmudul Hasan Shium",
    "lastName": "Shium",
    "googleId": "114596070347235844275",
    "picture": "https://lh3.googleusercontent.com/a/ACg8ocIccSN1Ym79aDziPMDzab315am2CTrxH1A3S5XsDOfmy7Rgt3w=s96-c",
    "createdAt": "2025-06-14T13:17:18.168Z",
    "updatedAt": "2025-06-14T13:17:18.168Z",
    "__v": 0,
    "accountStatus": "active",
    "role": "user",
    "id": "684d765e12e2d6b55490dd63"
  }
]
//ideal userdata getAll
{
  "success": true, // Indicate success/failure explicitly
  "data": [
    {
      "_id": "68373bb20386e48d16144d6d",
      "email": "officials.shium@gmail.com",
      "firstName": "Sheikh Mahmudul Hasan",
      "lastName": "Shium",
      "accountStatus": "active",
      "roles": ["owner", "admin"],
      "lastLogin": "2025-06-16T10:00:00.000Z" // Example,
    },
    {
      "_id": "68377756edbb4d47472fa4a1",
      "email": "sheikh.mahmudul.hasan.shium.aiub@gmail.com",
      "firstName": "Sheikh Mahmudul Hasan",
      "lastName": "Shium",
      "accountStatus": "active",
      "roles": ["admin"],
      "lastLogin": "2025-06-15T18:30:00.000Z"
    },
    {
      "_id": "68470e79a5ec9905a77ebb09",
      "email": "shanjidasaima2020@gmail.com",
      "firstName": "Shanjida",
      "lastName": "Saima",
      "accountStatus": "active",
      "roles": ["user"],
      "lastLogin": "2025-06-16T08:00:00.000Z"
    },
    {
      "_id": "684d765e12e2d6b55490dd63",
      "email": "sheikhmahmudulhasanshium2000@gmail.com",
      "firstName": "Sheikh Mahmudul Hasan Shium",
      "lastName": "Shium",
      "accountStatus": "active",
      "roles": ["user"],
      "lastLogin": null // Example: User hasn't logged in yet
    }
  ],
  "pagination": { // Pagination metadata
    "totalItems": 4,  // Total number of users (before pagination)
    "currentPage": 1, // Current page number
    "pageSize": 10,  // Number of items per page (example)
    "totalPages": 1   // Total number of pages
  }
}

//with 2fa
{
  "success": true,
  "data": [
    {
      "_id": "68373bb20386e48d16144d6d",
      "email": "officials.shium@gmail.com",
      "firstName": "Sheikh Mahmudul Hasan",
      "lastName": "Shium",
      "accountStatus": "active",
      "roles": ["owner", "admin"],
      "lastLogin": "2025-06-16T10:00:00.000Z",
      "is2FAEnabled": true // Added: Indicates if 2FA is enabled
    },
    {
      "_id": "68377756edbb4d47472fa4a1",
      "email": "sheikh.mahmudul.hasan.shium.aiub@gmail.com",
      "firstName": "Sheikh Mahmudul Hasan",
      "lastName": "Shium",
      "accountStatus": "active",
      "roles": ["admin"],
      "lastLogin": "2025-06-15T18:30:00.000Z",
      "is2FAEnabled": false // Added
    },
    {
      "_id": "68470e79a5ec9905a77ebb09",
      "email": "shanjidasaima2020@gmail.com",
      "firstName": "Shanjida",
      "lastName": "Saima",
      "accountStatus": "active",
      "roles": ["user"],
      "lastLogin": "2025-06-16T08:00:00.000Z",
      "is2FAEnabled": true // Added
    },
    {
      "_id": "684d765e12e2d6b55490dd63",
      "email": "sheikhmahmudulhasanshium2000@gmail.com",
      "firstName": "Sheikh Mahmudul Hasan Shium",
      "lastName": "Shium",
      "accountStatus": "active",
      "roles": ["user"],
      "lastLogin": null,
      "is2FAEnabled": false // Added
    }
  ],
  "pagination": {
    "totalItems": 4,
    "currentPage": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
//entry data
{
  "_id": "68373bb20386e48d16144d6d",
  "email": "officials.shium@gmail.com",
  "firstName": "Sheikh Mahmudul Hasan",
  "lastName": "Shium",
  "accountStatus": "active",
  "roles": ["owner", "admin"],
  "lastLogin": "2025-06-16T10:00:00.000Z",
  "is2FAEnabled": true,
  "twoFAMethod": "authenticatorApp",
  "twoFASecret": "ENCRYPTED_SECRET_KEY", // Important: Encrypted!
  "backupCodes": ["ENCRYPTED_CODE1", "ENCRYPTED_CODE2"] // Important: Encrypted!
}
Changelog - v1.1.0 (2024-06-27)
This is a major feature and security release that introduces a suite of powerful new tools for administrators, significantly hardens security protocols around user authentication, and implements a comprehensive, user-friendly notification system. Additionally, the core social module has been fully implemented, moving from placeholder logic to a production-ready state.
âœ¨ New Features & Admin Enhancements
Admin Analytics Dashboard: A new, admin-only endpoint (GET /users/analytics) has been introduced, providing key metrics on user engagement and platform growth.
Weekly User Growth Statistics: The analytics service now calculates and displays week-over-week new user growth, including a percentage change.
Automated Announcement Notifications: Creating a visible announcement now automatically generates an in-app system notification for all users, driving engagement with new content.
Support Ticket Notifications: Users now receive an in-app system notification when an administrator replies to their support ticket, improving communication response times.
Admin View for Hidden Content: The GET /announcements endpoint now allows authenticated administrators to view hidden (visible: false) announcements, which are inaccessible to the public.
ðŸ”’ Security & Privacy Enhancements
2FA Brute-Force Protection: Implemented a strict attempt limit. After 5 consecutive failed OTP entries, the user's account is locked from 2FA login for 24 hours to prevent credential stuffing and brute-force attacks.
Reduced OTP Lifespan: The expiration time for 2FA One-Time Passwords (OTPs) has been reduced from 10 minutes to a much safer 2 minutes, minimizing the window for potential interception.
Enhanced User Privacy: The public user directory (GET /users/directory) now respects the "Private Account" setting, correctly hiding users who have enabled this preference from public listings.
Guaranteed Critical Email Delivery: All critical security emails (OTP codes, password resets, ban/unban notices) are now guaranteed to be sent, bypassing any user-defined notification preferences to ensure account security is never compromised.
Secure Optional Authentication: A new OptionalAuthGuard was implemented to allow endpoints to serve both public and authenticated users securely without code duplication, ensuring proper access control on mixed-use routes.
ðŸš€ Improvements & Refinements
Full Social Module Implementation: Replaced all placeholder logic in the SocialModule with complete, production-ready code. This includes full database interactions for:
Friends System: Sending, accepting, rejecting, and removing friends.
Followers System: Following and unfollowing users.
User Blocking: Full implementation of blocking and unblocking users, which also automatically removes them from all mutual social connections (friends, followers, etc.).
Advanced Notification Filtering: The GET /notifications endpoint has been upgraded to support powerful filtering by read status (isRead=true/false) and by notification type (e.g., announcement, support_reply).
Granular Notification Controls: Users can now unsubscribe from non-essential "Announcement & Newsletter" emails via a direct link in the email footer that takes them to their profile settings page.
Unified Welcome Experience: All new users, whether signing up via email/password or Google OAuth, now receive a consistent and professionally branded "Welcome to CiRQL" email and an in-app welcome notification.
Build & Type-Safety Fixes: Resolved all Vercel build errors (TS2554, TS2339) by replacing deprecated Mongoose constructor patterns (new Model()) with the type-safe Model.create() method and correcting type definitions in various services, ensuring a stable and reliable build process.